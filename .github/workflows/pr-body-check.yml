name: PR Body Check

on: 
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]

jobs:
  check-linked-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: read
      pull-requests: write
    steps:
      - uses: nearform-actions/github-action-check-linked-issues@v1
        id: check-linked-issues
  check-unchecked-tasks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v6
        with:
          script: |
            function getPendingTasks(body) {
              let responseString = "";
              try {
                  const uncompletedTasks = body.match(/(- \[[ ]\].+)/g);
                  if (uncompletedTasks != undefined) {
                      responseString += 'Uncompleted Tasks\n';
                      uncompletedTasks.forEach(u => {
                          responseString += `${u}\n`;
                      });
                  }
              } catch (e) {
                  responseString = "";
              }
              return responseString;
            }
            async function run() {
              try {
                  const prBody = context?.payload?.pull_request?.body;
                  if (!prBody) {
                      console.log("PR don't have tasks to check");
                      return
                  }
                  console.log('Getting a list of uncompleted tasks: ');
                  let pendingTasks = getPendingTasks(prBody);
                  console.log(pendingTasks);
                  let isTaskListCompleted = false;
                  if (!pendingTasks) {
                      isTaskListCompleted = true;
                  }
                  console.log(`All tasks completed: ${isTaskListCompleted}`);
                
                  if (isTaskListCompleted) {
                      console.log(`SUCCESS: All tasks completed`);
                      return;
                  } else {
                      console.log(`FAILED: Some tasks are still pending! \n${pendingTasks}\nLength: ${pendingTasks.length}`);
                  }
              } catch (error) {
                  console.log(error.message)
              }
            }
            run();